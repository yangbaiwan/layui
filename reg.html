<!DOCTYPE html>
<html lang="en">

<head>
    <title>CRM管理系统</title>
    <link rel="icon" href="__PUBLIC__/img/favicon.ico" type="image/x-icon"/>
    
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <link rel="stylesheet" href="__PUBLIC__/login/css/style.css" />
    <link rel="stylesheet" href="__PUBLIC__/layui/css/layui.css" />
    <style>
        .layui-form-item {
            color: white;
        }
        .btnPosi {
            position: absolute;
            right: 0px;
            top: 0;
            display: inline-block;
            height: 38px;
            line-height: 38px;
            padding: 0 18px;
            background-color: #009688;
            color: #fff;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            width: 70px;
            box-sizing: content-box;
            text-align: center;
        }
        .select-width {
            width: 34%;
            display: inline-block;
            margin: 0;
        } 
        .layui-input-inline{
            width: 190px;
        }
        .layui-input-block1{
            margin-left: 0; 
        } 
        .layui-row:after, .layui-row:before{
            display:inline-block;
        }
        .foorter-btn {
            width: 200px;
            margin-top: 30px;
        }
        .layui-form-select dl dd, .layui-form-select dl dt{
            color: black!important;
        }
        .logo-img{
            width: 400px;
            font-size: 18px;
            color: #fff;
            text-align: center;
            position: fixed;
            left: 50%;
            top: 50%;
            margin-top: -400px;
            margin-left: -225px;
}
.logo-img img {
    width: 100%;
}
.login {
    height: 520px;    margin: -230px 0 0 -225px;
}
        @media screen and (max-width: 992px){
            .login{
        width:96%;
        margin: 0;
        height: auto;
        background:transparent;
        -webkit-transform:translate(-50%, -50%);
    }
    .logo-img {
        width: 250px;
        text-align: center;
        position: fixed;
        left: 50%;
        top: 50%;
        margin-top: -300px;
        margin-left: -125px;
}
    .logo-img img {
        width: 100%;
    }
    .logo {
        width: auto;
    }
            
        }
    </style>
</head>

<body class="body_bj">
    <div class="logo-img">
        <img src="__PUBLIC__/login/img/logo.png" alt="">
    </div>
    <div class="login">
        <div class="logo">
            注册账号
        </div>
        <form class="layui-form" action="" style="width: 90%;">
            <div class="layui-form-item">
                <label class="layui-form-label">姓名</label>
                <div class="layui-input-block">
                    <input type="text" name="adminName" lay-verify="adminName" onkeyup="this.value=this.value.replace(/\s+/g,'')" required lay-verify="required" maxlength="20"
                        placeholder="请输入姓名" autocomplete="off" class="layui-input" />
                </div>
            </div>
            <div class="layui-form-item" style="display: none;">
                <label class="layui-form-label">姓名</label>
                <div class="layui-input-block">
                    <input type="text" name="type" lay-verify="type" required lay-verify="required" maxlength="5"
                        placeholder="请输入姓名" autocomplete="off" class="layui-input" value="1" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">性别</label>
                <div class="layui-input-block">
                    <input type="radio" name="adminSex" value="1" title="男" />
                    <input type="radio" name="adminSex" value="2" title="女" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">手机号</label>
                <div class="layui-input-block">
                    <input type="text" name="adminPhone" id="tel"  onkeyup="this.value=this.value.replace(/\s+/g,'')" required lay-verify="required|phone|number"
                        placeholder="请输入手机号" autocomplete="off" class="layui-input" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">密码</label>
                <div class="layui-input-block">
                    <input type="password" name="adminPass"  onkeyup="this.value=this.value.replace(/\s+/g,'')" maxlength="20" required lay-verify="required|adminPass"
                        placeholder="请输入密码" autocomplete="off" class="layui-input" />
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">店铺ID</label>
                <div class="layui-input-block" style="position: relative;">
                    <input type="text" name="adminShopId"  onkeyup="this.value=this.value.replace(/\s+/g,'')" required lay-verify="required|number" placeholder="请输入店铺ID"
                        autocomplete="off" class="layui-input" />

                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">获取验证码</label>
                <div class="layui-input-block" style="position: relative;">
                    <input type="text" name="code" required lay-verify="required|number"  onkeyup="this.value=this.value.replace(/\s+/g,'')" placeholder="请输入验证码"
                        autocomplete="off" class="layui-input" style="position: relative;width: 46%;" />
                    <button type="button" class="btnPosi layui-btn">获取验证码</button>

                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label layui-row">申请权限</label>
                <div class="layui-input-block layui-row">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <select id="mySelect" name="jueShe" lay-verify="required" lay-filter="mySelect"><option value=""></option></select>
                    </div>
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <select id="mySelectChil" name="quanXian" lay-verify="required">
                            <option value=""></option>
                        </select>
                    </div>
                </div>

            </div>
            <div class="layui-form-item">
                <div class="layui-input-block layui-row">
                    <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="formDemo">注册</button>
                </div>
            </div>
        </form>
    </div>

    <script type="text/javascript" src="__PUBLIC__/layui/layui.js"></script>
    <script type="text/javascript" src="__PUBLIC__/js/particles.min.js"></script>
    <script>
        layui.use(['form', 'jquery'], function () {
            var form = layui.form,
                $ = layui.jquery;


            form.verify({
                adminName: [/^[a-zA-Z\u4e00-\u9fa5]+$/, '请输入二十个以内的中文或英文组合'],
                adminPass: [/^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){4,19}$/, '只能输入5-20个以字母开头、可带数字、“_”、“.”的组合']

            });

            function setCookie(key, val, time) { //设置cookie方法
                var date = new Date(); //获取当前时间
                var expiresDays = time; //将date设置为n天以后的时间
                date.setTime(date.getTime() + expiresDays * 24 * 3600 * 1000); //格式化为cookie识别的时间
                document.cookie = key + "=" + val + ";expires=" + date.toGMTString() + ";path=/"; //设置cookie
            };
            $.ajax({
                url: "{:U('Login/registerRequest')}",
                type: 'POST',
                data: {},
                success: function (data) {
                    console.log(data);
                    data.map(function (value, index, array) {
                        $('select[name="jueShe"]').append("<option value='" + value.juesheid +
                            "'>" + value.jueshename + "</option>")

                    });

                    layui.use('form', function () {
                        var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                        form.render();
                    });
                    form.on('select(mySelect)', function (res) {
                        
                        console.log($('#mySelectChil').children());
                        $('#mySelectChil').children().remove();
                        console.log(res.value);
                        if (res.value == 1) {
                            data[res.value - 1].quanxianid.map(function (value, index,
                                array) {
                                console.log(array);
                                $('#mySelectChil').append(
                                    "<option value='" +
                                    array[index].quanid +
                                    "'>" + array[index].quanname + "</option>")
                                // console.log(value, index, array);
                            });


                        } else if (res.value == 2) {
                            data[res.value - 1].quanxianid.map(function (value, index,
                                array) {

                                $('#mySelectChil').append(
                                    "<option value='" +
                                    array[index].quanid +
                                    "'>" + array[index].quanname + "</option>")
                                // console.log(value, index, array);
                            });
                        } else if (res.value == 3) {
                            data[res.value - 1].quanxianid.map(function (value, index,
                                array) {

                                $('#mySelectChil').append(
                                    "<option value='" +
                                    array[index].quanid +
                                    "'>" + array[index].quanname + "</option>")
                                // console.log(value, index, array);
                            });
                        };
                        layui.use('form', function () {
                            var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                            form.render();
                        });
                    });

                }

            })
            // //监听提交
            form.on('submit(formDemo)', function (data) {
                console.log(data);
                // layer.msg(JSON.stringify(data.field));
                $.ajax({
                    url: "{:U('Login/adminRegister')}",
                    type: 'POST',
                    data: data.field,
                    success: function (res) {
                        if (res.state == 2000) {
                            layer.msg('注册成功，正在登陆!');
                            $.ajax({
                                url: "{:U('Login/loginVerif')}",
                                type: 'POST',
                                data: {
                                    adminPhone: data.field.adminPhone,
                                    adminPass: data.field.adminPass
                                },
                                success: function (res) {
                                    if (res.state == 2000) {
                                        setCookie('success', data.field.adminPhone,
                                            1);
                                            
                                        sessionStorage.setItem('dataId', 1);
                                        window.location.href =
                                            "{:U('Index/index')}"

                                    } else if (res.state == 4001) {
                                        layer.msg('账号或密码输入不正确!');
                                    } else if (res.state == 4004) {
                                        layer.msg('用户未注册!');
                                    } else if (res.state == 2001) {
                                        layer.msg('登录成功，未绑定微信!');
                                        setTimeout(function () {
                                            setCookie('success', data.field.adminPhone,
                                            1);
                                            window.location.href =
                                                "{:U('Login/adminWeiXin')}"
                                        }, 1000)
                                    }
                                }
                            });
                        } else if (res.state == 3000) {
                            layer.msg('注册失败!');
                        } else if (res.state == 4004) {
                            layer.msg('验证码不正确!');
                        } else if (res.state == 4001) {
                            layer.msg('此手机号码已经注册!');
                        }
                    }
                });

                return false;
            });
            //监听提交


            function isPoneAvailable(a) {
                var myreg = /^[1][3,4,6,5,7,8,9][0-9]{9}$/;
                if (!myreg.test(a)) {
                    return false;
                } else {
                    return true;
                }
            }
            var time = 60;

            function settime() {

                if (time == 0) {
                    $('.btnPosi').text('获取验证码');
                    $('.btnPosi').attr('disabled', false);
                    time = 60;
                    return false;
                } else {
                    $('.btnPosi').attr('disabled', true);
                    $('.btnPosi').text(time-- + 's');
                }

                setTimeout(function () {
                    settime();
                }, 1000);
            }

            $('.btnPosi').on('click', function () {
                var tel = $("#tel").val();
                var re = new RegExp('^[ ]+$');
                if (tel != '' || re.test(tel)) {
                    console.log($("input[name^='code']").val())
                    if (isPoneAvailable(tel)) {
                        $.ajax({
                            url: "{:U('Login/phoneHuoQuYanZhengMa')}",
                            type: 'POST',
                            data: {
                                adminPhone: tel
                            },
                            success: function name(data) {
                                console.log(data);
                                if (data.state == 2000) {
                                    layer.msg('验证码发送成功!');

                                    settime();
                                } else if (data.state == 4001) {
                                    layer.msg('此手机号已注册!');
                                } else if (data.state == 3001) {
                                    layer.msg('5分钟内发送多次!')
                                } else if (data.state == 3000) {
                                    layer.msg('验证码发送失败!');
                                }
                            }
                        })
                    } else {
                        layer.msg('请输入正确的手机号码!');
                    }

                } else {
                    layer.msg('请输入手机号码!');
                }

            })
        });
    </script>
</body>

</html>